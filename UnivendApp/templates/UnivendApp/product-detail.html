{% extends 'UnivendApp/base.html' %}
{% load static %}

{% block title %}{{ listing.title }}{% endblock %}

{% block stylesheet %}
    <link href="{% static 'css/product-detail.css' %}" rel="stylesheet">
    <link href="{% static 'css/homepage-style.css' %}" rel="stylesheet">
{% endblock %}

{% block top_bar %}
    <div class="top-nav">
        <button class="back-button" onclick="window.history.back()">
            <span class="material-icons-round">arrow_back</span>
        </button>
        <button class="share-button">
            <span class="material-icons-round">share</span>
        </button>
    </div>
{% endblock %}

{% block content %}
    <div class="image-slider">
        <div class="slider-container">
            {% for image in listing.images.all %}
                <img src="{{ image.image.url }}" alt="{{ listing.title }}" class="{% if forloop.first %}active{% endif %}">
            {% empty %}
                <img src="https://via.placeholder.com/300" alt="No Image">
            {% endfor %}
        </div>
        <div class="slider-dots">
            {% for image in listing.images.all %}
                <span class="dot {% if forloop.first %}active{% endif %}"></span>
            {% endfor %}
        </div>
    </div>

    <div class="product-info">
        <div class="main-info">
            <h1>{{ listing.title }}</h1>
            <div class="price-tag">₦{{ listing.price }} {% if listing.price_type != 'fixed' %}({{ listing.price_type|title }}){% endif %}</div>
        </div>

        <div class="seller-info">
            <img src="{% if listing.seller.profile_picture %}{{ listing.seller.profile_picture.url }}{% else %}https://i.pravatar.cc/150{% endif %}" alt="{{ listing.seller.first_name }}" class="seller-avatar">
            <div class="seller-details">
                <h3>{{ listing.seller.first_name }} {{ listing.seller.last_name }}</h3>
                <p>{{ listing.seller.department.name }} • {{ listing.seller.get_average_rating|floatformat:1 }} ⭐</p>
            </div>
            <button class="follow-button">Follow</button>
        </div>

        <div class="product-details">
            <h2>Details</h2>
            <div class="details-grid">
                <div class="detail-item">
                    <span class="material-icons-round">schedule</span>
                    <div class="detail-info">
                        <p class="label">Listed</p>
                        <p class="value">{{ listing.created_at|timesince }} ago</p>
                    </div>
                </div>
                <div class="detail-item">
                    <span class="material-icons-round">location_on</span>
                    <div class="detail-info">
                        <p class="label">Location</p>
                        <p class="value">{{ listing.location }}</p>
                    </div>
                </div>
                {% if listing.condition %}
                    <div class="detail-item">
                        <span class="material-icons-round">inventory_2</span>
                        <div class="detail-info">
                            <p class="label">Condition</p>
                            <p class="value">{{ listing.get_condition_display }}</p>
                        </div>
                    </div>
                {% endif %}
                <div class="detail-item">
                    <span class="material-icons-round">category</span>
                    <div class="detail-info">
                        <p class="label">Category</p>
                        <p class="value">{{ listing.category.name }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="description">
            <h2>Description</h2>
            <p>{{ listing.description }}</p>
            {% if tags_list %}
                <div class="specs-list">
                    {% for tag in tags_list %}
                        <span class="spec-tag">{{ tag }}</span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>

        <div class="safety-tips" style="margin-bottom: 80px;">
            <div class="safety-header">
                <span class="material-icons-round">security</span>
                <h2>Safety Tips</h2>
            </div>
            <ul>
                <li>Meet in a public place</li>
                <li>Don't pay in advance</li>
                <li>Check the item before paying</li>
            </ul>
        </div>
    </div>

    <div class="bottom-actions" style="margin-bottom:71px;">
        <button class="message-button" onclick="window.location.href='{% url 'chat-detail' listing.seller.id listing.id %}'">
            <span class="material-icons-round">chat</span>
            Message Seller
        </button>
        <button class="buy-button" id="show-contact-btn" data-phone="{{ listing.seller.phone_number }}">Show Contact</button>
    </div>
    
    <!-- Contact info is now shown directly on the button -->

    <div class="report-modal" id="reportModal">
        <div class="modal-content">
            <h3>Report Listing</h3>
            <div class="report-options">
                <button class="report-option">Suspicious or spam</button>
                <button class="report-option">Prohibited item</button>
                <button class="report-option">Wrong category</button>
                <button class="report-option">Other</button>
            </div>
            <button class="cancel-button">Cancel</button>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Image slider functionality
        const images = document.querySelectorAll('.slider-container img');
        const dots = document.querySelectorAll('.slider-dots .dot');
        let currentImage = 0;

        function showImage(index) {
            images.forEach((img, i) => img.classList.toggle('active', i === index));
            dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
        }

        dots.forEach((dot, i) => {
            dot.addEventListener('click', () => {
                currentImage = i;
                showImage(currentImage);
            });
        });

        // Report modal
        const reportModal = document.getElementById('reportModal');
        document.querySelector('.share-button').addEventListener('click', () => {
            reportModal.style.display = 'block';
        });

        document.querySelector('.cancel-button').addEventListener('click', () => {
            reportModal.style.display = 'none';
        });

        // Show Contact functionality
        const showContactBtn = document.querySelector('#show-contact-btn');

        if (showContactBtn) {
            showContactBtn.addEventListener('click', () => {
                const phoneNumber = showContactBtn.getAttribute('data-phone');
                if (phoneNumber) {
                    // Clear the button text
                    showContactBtn.innerHTML = '';
                    
                    // Create a clickable phone link with icon
                    const phoneLink = document.createElement('a');
                    phoneLink.href = `tel:${phoneNumber}`;
                    phoneLink.innerHTML = `<span class="material-icons-round" style="font-size: 16px; vertical-align: middle; margin-right: 5px;">call</span>${phoneNumber}`;
                    phoneLink.style.color = 'inherit'; // Maintain button text color
                    phoneLink.style.textDecoration = 'none'; // Remove underline
                    phoneLink.style.display = 'block'; // Fill the button
                    phoneLink.style.width = '100%';
                    phoneLink.style.height = '100%';
                    
                    // Add the link to the button
                    showContactBtn.appendChild(phoneLink);
                } else {
                    showContactBtn.textContent = 'No phone number available';
                }
                showContactBtn.disabled = false; // Keep enabled so the link is clickable
            });
        }
    </script>
{% endblock %}